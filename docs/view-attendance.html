<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <title>Parent — Student Report Card</title>
        <style>
            :root{--bg:#071027;--panel:#0c1726;--muted:#9aa9bf;--accent:#6c5ce7;--success:#22c55e}
            *{box-sizing:border-box}
            body{margin:0;font-family:Inter,Segoe UI,Arial,sans-serif;background:linear-gradient(180deg,#071027 0%,#071832 100%);color:#eaf1fb}
            .wrap{width:100%;max-width:none;margin:0;padding:28px 20px;display:grid;grid-template-columns:340px minmax(0,1fr) 360px;gap:32px}
            .card-left{background:linear-gradient(180deg,#081226,#0a1630);border-radius:14px;padding:28px;box-shadow:0 18px 48px rgba(2,7,23,.6)}
            .avatar{width:96px;height:96px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;background:linear-gradient(135deg,#6c5ce7,#4ade80);font-weight:700;font-size:32px}
            .student-name{text-align:center;font-size:20px;font-weight:700}
            .student-meta{text-align:center;color:var(--muted);font-size:14px;margin-top:8px}
            .badge{display:inline-block;padding:6px 10px;border-radius:10px;background:#07361a;color:#aef5bf;font-weight:600;margin:12px auto}
            .section{margin-top:18px;background:rgba(255,255,255,0.02);padding:14px;border-radius:12px}
            .row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.03)}
            .row:last-child{border-bottom:0}
            .main{display:flex;flex-direction:column;gap:14px}
            .top-stat{display:flex;gap:16px;flex-wrap:wrap}
            .stat{flex:1;min-width:150px;background:linear-gradient(180deg,#08142a,#061026);padding:16px;border-radius:12px;text-align:center}
            .stat .value{font-size:22px;font-weight:800}
            .panel{background:linear-gradient(180deg,#071229,#051023);padding:20px;border-radius:14px}
            .report-header{display:flex;justify-content:space-between;align-items:center;gap:16px;flex-wrap:wrap}
            .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
            select,input{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#eaf1fb;padding:10px 12px;border-radius:10px}
            button{background:linear-gradient(90deg,var(--accent),#4f46e5);color:#fff;border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-size:14px}
            button:hover{opacity:0.9}
            .subjects{margin-top:22px;border-radius:10px;overflow-x:auto}
            table{width:100%;border-collapse:collapse;min-width:600px}
            th,td{padding:18px 20px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left;vertical-align:middle}
            th{font-size:13px;color:var(--muted);letter-spacing:0.6px;text-transform:uppercase}
            tbody tr{line-height:1.8}
            tbody tr:hover{background:rgba(255,255,255,0.02)}
            .summary{display:flex;gap:14px;margin-top:20px;flex-wrap:wrap}
            .summary .box{flex:1;min-width:150px;background:rgba(255,255,255,0.02);padding:14px;border-radius:10px;text-align:center}
            .card-right{background:linear-gradient(180deg,#081226,#0a1630);border-radius:14px;padding:18px;box-shadow:0 18px 48px rgba(2,7,23,.6);display:flex;flex-direction:column;align-items:center;gap:12px}
            .card-right img{width:100%;height:auto;min-height:220px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);object-fit:cover;background:#081a2b}
            .card-right .caption{font-size:14px;color:var(--muted);text-align:center;margin-top:10px}
            @media(max-width:980px){.wrap{grid-template-columns:1fr;padding:16px}.card-left{order:2}.main{order:1}.card-right{order:3;display:none}}
        </style>
    </head>
    <body>
        <div class="wrap">
            <aside class="card-left">
                <div class="avatar" id="studentAvatar">...</div>
                <div class="student-name" id="studentName">Loading...</div>
                <div class="student-meta">Student ID: <strong id="studentNumber">...</strong></div>
                <div style="text-align:center;margin-top:10px"><span class="badge" id="enrollmentStatus">Enrolled</span></div>
                <div class="section">
                    <div class="row"><div>Last Enrollment</div><div style="color:var(--muted)" id="lastEnrollment">N/A</div></div>
                    <div class="row"><div>Year/Grade</div><div style="color:var(--muted)" id="yearGrade">N/A</div></div>
                    <div class="row"><div>Graduating</div><div style="color:var(--muted)" id="graduating">No</div></div>
                </div>
            </aside>

            <main class="main">
                <div class="top-stat">
                    <div class="stat"><div style="font-size:12px;color:var(--muted)">Attendance Rate</div><div class="value" id="attendanceRate">0%</div></div>
                    <div class="stat"><div style="font-size:12px;color:var(--muted)">GPA</div><div class="value" id="gpa">N/A</div></div>
                    <div class="stat"><div style="font-size:12px;color:var(--muted)">Days Present</div><div class="value" id="daysPresent">0</div></div>
                    <div class="stat"><div style="font-size:12px;color:var(--muted)">Days Absent</div><div class="value" id="daysAbsent">0</div></div>
                </div>

                <div class="panel">
                    <div class="report-header">
                        <h3 style="margin:0">Report Card</h3>
                        <div class="controls">
                            <button id="printBtn">Print / Save PDF</button>
                            <button id="exportCsv">Export CSV</button>
                        </div>
                    </div>

                    <div class="subjects" id="attendanceContainer">
                        <table>
                            <thead>
                                <tr><th>DATE</th><th>TIME IN</th><th>TIME OUT</th><th>STATUS</th><th style="text-align:right">VIEW</th></tr>
                            </thead>
                            <tbody id="attendanceBody">
                                <tr><td colspan="5" style="text-align:center;color:var(--muted);padding:40px">Loading attendance records...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="summary">
                        <div class="box"><div style="font-size:12px;color:var(--muted)">Remarks</div><div id="remarks" style="font-weight:700">No remarks</div></div>
                        <div class="box"><div style="font-size:12px;color:var(--muted)">Advisory</div><div id="advisory" style="font-weight:700">N/A</div></div>
                    </div>
                </div>

                <div class="panel">
                    <h3 style="margin-top:0">Attendance Summary</h3>
                    <div style="display:flex;gap:12px;margin-top:10px;flex-wrap:wrap">
                        <div style="flex:1;min-width:120px;background:rgba(255,255,255,0.02);padding:12px;border-radius:8px;text-align:center"><div style="color:var(--muted);font-size:12px">Total Days</div><div id="totalDays" style="font-weight:700">0</div></div>
                        <div style="flex:1;min-width:120px;background:rgba(255,255,255,0.02);padding:12px;border-radius:8px;text-align:center"><div style="color:var(--muted);font-size:12px">Present</div><div id="presentDays" style="font-weight:700">0</div></div>
                        <div style="flex:1;min-width:120px;background:rgba(255,255,255,0.02);padding:12px;border-radius:8px;text-align:center"><div style="color:var(--muted);font-size:12px">Absent</div><div id="absentDays" style="font-weight:700">0</div></div>
                    </div>
                </div>

                <div class="panel">
                    <h3 style="margin-top:0">Contact</h3>
                    <div style="display:flex;gap:12px;margin-top:10px;flex-wrap:wrap">
                        <div style="flex:1;min-width:200px;background:rgba(255,255,255,0.02);padding:12px;border-radius:8px"><div style="color:var(--muted);font-size:12px;margin-bottom:6px">Phone</div><div id="contactPhone" style="font-weight:700">N/A</div></div>
                        <div style="flex:1;min-width:200px;background:rgba(255,255,255,0.02);padding:12px;border-radius:8px"><div style="color:var(--muted);font-size:12px;margin-bottom:6px">Email</div><div id="contactEmail" style="font-weight:700;word-break:break-all">N/A</div></div>
                    </div>
                </div>
            </main>

            <aside class="card-right" id="photoViewer">
                <div style="width:100%;display:flex;justify-content:space-between;align-items:center">
                    <div style="font-weight:700">Camera Snapshot</div>
                    <button id="closePhoto" style="background:transparent;border:0;color:var(--muted);cursor:pointer;font-size:20px;padding:4px 8px">✕</button>
                </div>
                <img id="cameraPhoto" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='320' height='220'><rect width='100%' height='100%' fill='%23081a2b'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='%23aab9cc' font-family='Arial' font-size='16'>No photo selected</text></svg>" alt="Camera scan">
                <div class="caption" id="photoCaption">Click 'View' on a row to show the scan</div>
            </aside>
        </div>

        <script>
            // Configuration
            const SUPABASE_URL = 'https://ddblgwzylvwuucnpmtzi.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkYmxnd3p5bHZ3dXVjbnBtdHppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MDM4MjIsImV4cCI6MjA3OTM3OTgyMn0.EL7xhE0SbgvJ_R8ZAlkawOqRMi3yYMGFbGkqBMWMaJI';
            const VERIFY_API = 'https://ddblgwzylvwuucnpmtzi.supabase.co/functions/v1/verify-attendance-url';

            // Get URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const studentId = urlParams.get('student_id');
            const expires = urlParams.get('expires');
            const sig = urlParams.get('sig');

            async function verifySignedURL() {
                // If no signature, assume old-style unsigned URL (backward compatibility)
                if (!sig || !expires) {
                    console.log('No signature - using legacy unsigned URL');
                    return { valid: true, student_id: studentId };
                }

                // Verify signature via Supabase Edge Function
                try {
                    const verifyUrl = `${VERIFY_API}?student_id=${studentId}&expires=${expires}&sig=${encodeURIComponent(sig)}`;
                    const response = await fetch(verifyUrl, {
                        headers: {
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        return { valid: false, error: error.error || 'Invalid or expired link' };
                    }

                    const result = await response.json();
                    return result;

                } catch (error) {
                    console.error('Verification API error:', error);
                    // If API unavailable, fall back to unsigned mode (graceful degradation)
                    console.warn('Verification API unavailable - falling back to unsigned mode');
                    return { valid: true, student_id: studentId };
                }
            }

            async function loadAttendance() {
                if (!studentId) {
                    showError('No student ID provided. Please use the link from your SMS.');
                    return;
                }

                // Verify signed URL first
                const verification = await verifySignedURL();

                if (!verification.valid) {
                    showError(verification.error || 'Invalid or expired link. Please request a new one.');
                    return;
                }

                try {
                    // Fetch student info
                    const studentResponse = await fetch(`${SUPABASE_URL}/rest/v1/students?id=eq.${studentId}&select=*`, {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    });

                    if (!studentResponse.ok) throw new Error('Failed to fetch student data');
                    const students = await studentResponse.json();
                    if (students.length === 0) throw new Error('Student not found');

                    const student = students[0];

                    // Update student info
                    const fullName = `${student.first_name || ''} ${student.middle_name || ''} ${student.last_name || ''}`.trim();
                    const initials = `${(student.first_name || '')[0] || ''}${(student.last_name || '')[0] || ''}`.toUpperCase();
                    document.getElementById('studentAvatar').textContent = initials;
                    document.getElementById('studentName').textContent = fullName || 'Unknown';
                    document.getElementById('studentNumber').textContent = student.student_number || 'N/A';
                    document.getElementById('contactPhone').textContent = student.parent_guardian_contact || 'N/A';
                    document.getElementById('contactEmail').textContent = student.parent_guardian_email || student.email || 'N/A';

                    // Fetch attendance records
                    const attendanceResponse = await fetch(`${SUPABASE_URL}/rest/v1/attendance?student_id=eq.${studentId}&select=*&order=date.desc,time_in.desc`, {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    });

                    if (!attendanceResponse.ok) throw new Error('Failed to fetch attendance data');
                    const attendance = await attendanceResponse.json();

                    renderAttendance(attendance);

                } catch (error) {
                    console.error('Error loading attendance:', error);
                    showError('Failed to load attendance data. Please try again later.');
                }
            }

            function renderAttendance(records) {
                const tbody = document.getElementById('attendanceBody');
                tbody.innerHTML = '';

                if (records.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--muted);padding:40px">No attendance records found</td></tr>';
                    return;
                }

                // Calculate stats
                let present = 0, absent = 0, late = 0;
                records.forEach(rec => {
                    if (rec.status === 'present') present++;
                    else if (rec.status === 'absent') absent++;
                    else if (rec.status === 'late') late++;
                });

                const total = records.length;
                const rate = total > 0 ? Math.round((present / total) * 100) : 0;

                document.getElementById('attendanceRate').textContent = rate + '%';
                document.getElementById('daysPresent').textContent = present;
                document.getElementById('daysAbsent').textContent = absent;
                document.getElementById('totalDays').textContent = total;
                document.getElementById('presentDays').textContent = present;
                document.getElementById('absentDays').textContent = absent;

                // Render records
                records.forEach((rec, idx) => {
                    const tr = document.createElement('tr');
                    tr.className = 'attendance-row';

                    const timeIn = rec.time_in || 'N/A';
                    const timeOut = rec.time_out || 'N/A';
                    const status = rec.status || 'unknown';
                    const photo = extractPhotoUrl(rec.remarks);

                    const viewBtn = photo ? 
                        `<button class="view-btn" data-idx="${idx}" data-photo="${photo}" style="padding:6px 12px;border-radius:6px;background:rgba(108,92,231,.2);color:#c5bcff;border:1px solid rgba(108,92,231,.3);cursor:pointer">View</button>` : 
                        `<button disabled style="padding:6px 12px;border-radius:6px;background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,.06);cursor:not-allowed;opacity:.4">View</button>`;

                    tr.innerHTML = `
                        <td>${rec.date}</td>
                        <td>${timeIn}</td>
                        <td>${timeOut}</td>
                        <td><span style="padding:4px 8px;border-radius:6px;font-size:11px;background:${getStatusColor(status)}">${status.toUpperCase()}</span></td>
                        <td style="text-align:right">${viewBtn}</td>
                    `;
                    tbody.appendChild(tr);

                    if (photo) {
                        tr.querySelector('.view-btn').addEventListener('click', () => {
                            showPhoto(photo, rec);
                        });
                    }
                });
            }

            function extractPhotoUrl(remarks) {
                if (!remarks) return null;
                const match = remarks.match(/https?:\/\/[^\s]+/);
                return match ? match[0] : null;
            }

            function getStatusColor(status) {
                const colors = {
                    'present': 'rgba(34,197,94,.2);color:#86efac',
                    'absent': 'rgba(239,68,68,.2);color:#fca5a5',
                    'late': 'rgba(251,191,36,.2);color:#fde047',
                    'excused': 'rgba(59,130,246,.2);color:#93c5fd'
                };
                return colors[status] || 'rgba(255,255,255,.05);color:var(--muted)';
            }

            function showPhoto(url, record) {
                const viewer = document.getElementById('photoViewer');
                const img = document.getElementById('cameraPhoto');
                const caption = document.getElementById('photoCaption');

                // Viewer is already visible, just update content

                if (!url) {
                    img.src = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='320' height='220'><rect width='100%' height='100%' fill='%23081a2b'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='%23aab9cc' font-family='Arial' font-size='16'>No photo available</text></svg>";
                    caption.textContent = record ? `${record.date} — ${record.status}` : 'No photo available';
                    return;
                }

                img.src = url;
                caption.textContent = record ? `${record.date} • ${record.time_in || 'N/A'} - ${record.time_out || 'N/A'}` : '';
            }

            function showError(message) {
                document.querySelector('.wrap').innerHTML = `
                    <div style="grid-column:1/-1;text-align:center;padding:60px 20px">
                        <div style="font-size:48px;margin-bottom:20px">⚠️</div>
                        <h2 style="color:var(--muted);margin-bottom:10px">Error</h2>
                        <p style="color:var(--muted)">${message}</p>
                    </div>
                `;
            }

            // Event listeners
            document.getElementById('closePhoto').addEventListener('click', () => {
                const viewer = document.getElementById('photoViewer');
                const img = document.getElementById('cameraPhoto');
                const caption = document.getElementById('photoCaption');
                // Reset to default placeholder
                img.src = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='320' height='220'><rect width='100%' height='100%' fill='%23081a2b'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='%23aab9cc' font-family='Arial' font-size='16'>No photo selected</text></svg>";
                caption.textContent = "Click 'View' on a row to show the scan";
            });

            document.getElementById('printBtn').addEventListener('click', () => window.print());

            document.getElementById('exportCsv').addEventListener('click', () => {
                const rows = [['Date', 'Time In', 'Time Out', 'Status']];
                document.querySelectorAll('#attendanceBody tr').forEach(r => {
                    const cols = r.querySelectorAll('td');
                    if (cols.length >= 4) {
                        rows.push([
                            cols[0].textContent.trim(),
                            cols[1].textContent.trim(),
                            cols[2].textContent.trim(),
                            cols[3].textContent.trim()
                        ]);
                    }
                });
                const csv = rows.map(r => r.map(c => `"${c.replace(/"/g, '""')}"`).join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'attendance-history.csv';
                a.click();
                URL.revokeObjectURL(url);
            });

            // Load attendance on page load
            loadAttendance();
        </script>
    </body>
</html>

From 88fce5a15747a4e1df67b8ad2416f0bd7844be99 Mon Sep 17 00:00:00 2001
From: IoT Attendance System <iot@attendance.local>
Date: Fri, 28 Nov 2025 08:46:48 +0800
Subject: [PATCH 2/2] fix: correct attendance view to use student UUID instead
 of student_number

---
 docs/view-attendance.html   | 79 +++++++++++++++++++++++--------------
 public/view-attendance.html | 79 +++++++++++++++++++++++--------------
 2 files changed, 98 insertions(+), 60 deletions(-)

diff --git a/docs/view-attendance.html b/docs/view-attendance.html
index 1f81d44..2e49d3b 100644
--- a/docs/view-attendance.html
+++ b/docs/view-attendance.html
@@ -221,9 +221,9 @@
             document.getElementById('studentId').textContent = studentId;
             
             try {
-                // Fetch attendance records
-                const response = await fetch(
-                    `${SUPABASE_URL}/rest/v1/attendance?student_id=eq.${studentId}&select=*&order=date.desc,time_in.desc&limit=30`,
+                // First, fetch student info to get UUID
+                const studentResponse = await fetch(
+                    `${SUPABASE_URL}/rest/v1/students?student_number=eq.${studentId}&select=id,first_name,last_name,grade_level,section`,
                     {
                         headers: {
                             'apikey': SUPABASE_ANON_KEY,
@@ -232,15 +232,29 @@
                     }
                 );
                 
-                if (!response.ok) {
-                    throw new Error(`Failed to load attendance: ${response.status}`);
+                if (!studentResponse.ok) {
+                    throw new Error(`Student not found: ${studentResponse.status}`);
                 }
                 
-                const records = await response.json();
+                const students = await studentResponse.json();
+                if (students.length === 0) {
+                    showError('Student not found. Please check the student ID.');
+                    return;
+                }
                 
-                // Fetch student info
-                const studentResponse = await fetch(
-                    `${SUPABASE_URL}/rest/v1/students?student_number=eq.${studentId}&select=first_name,last_name,grade_level,section`,
+                const student = students[0];
+                const studentUUID = student.id;
+                
+                // Update student info display
+                document.getElementById('studentName').textContent = 
+                    `${student.first_name} ${student.last_name}`;
+                document.getElementById('studentDetails').innerHTML = 
+                    `Student ID: ${studentId} | Grade: ${student.grade_level} - ${student.section}`;
+                document.getElementById('studentInfo').style.display = 'block';
+                
+                // Now fetch attendance records using UUID
+                const response = await fetch(
+                    `${SUPABASE_URL}/rest/v1/attendance?student_id=eq.${studentUUID}&select=*&order=timestamp.desc&limit=30`,
                     {
                         headers: {
                             'apikey': SUPABASE_ANON_KEY,
@@ -249,18 +263,12 @@
                     }
                 );
                 
-                if (studentResponse.ok) {
-                    const students = await studentResponse.json();
-                    if (students.length > 0) {
-                        const student = students[0];
-                        document.getElementById('studentName').textContent = 
-                            `${student.first_name} ${student.last_name}`;
-                        document.getElementById('studentDetails').innerHTML = 
-                            `Student ID: ${studentId} | Grade: ${student.grade_level} - ${student.section}`;
-                    }
+                if (!response.ok) {
+                    throw new Error(`Failed to load attendance: ${response.status}`);
                 }
                 
-                document.getElementById('studentInfo').style.display = 'block';
+                const records = await response.json();
+                
                 document.getElementById('loading').style.display = 'none';
                 
                 displayAttendance(records);
@@ -275,29 +283,27 @@
             const container = document.getElementById('attendanceContainer');
             
             if (records.length === 0) {
-                container.innerHTML = '<div class="no-records">No attendance records found.</div>';
+                container.innerHTML = '<div class="no-records">ðŸ“… No attendance records found yet.<br><br>Records will appear here once student checks in at school.</div>';
                 return;
             }
             
             let html = '<table class="attendance-table">';
             html += '<thead><tr>';
-            html += '<th>Date</th>';
-            html += '<th>Time In</th>';
-            html += '<th>Time Out</th>';
+            html += '<th>Date & Time</th>';
+            html += '<th>Scan Type</th>';
             html += '<th>Status</th>';
             html += '</tr></thead>';
             html += '<tbody>';
             
             records.forEach(record => {
-                const date = record.date || 'N/A';
-                const timeIn = record.time_in ? formatTime(record.time_in) : '-';
-                const timeOut = record.time_out ? formatTime(record.time_out) : '-';
-                const status = record.status || 'unknown';
+                // Handle timestamp field (from your attendance system)
+                const timestamp = record.timestamp || record.created_at || 'N/A';
+                const scanType = record.scan_type || record.type || 'check-in';
+                const status = record.status || 'present';
                 
                 html += '<tr>';
-                html += `<td>${formatDate(date)}</td>`;
-                html += `<td>${timeIn}</td>`;
-                html += `<td>${timeOut}</td>`;
+                html += `<td>${formatDateTime(timestamp)}</td>`;
+                html += `<td><span class="status-badge status-present">${scanType.replace('_', ' ').toUpperCase()}</span></td>`;
                 html += `<td><span class="status-badge status-${status.toLowerCase()}">${status}</span></td>`;
                 html += '</tr>';
             });
@@ -306,6 +312,19 @@
             container.innerHTML = html;
         }
         
+        function formatDateTime(dateTimeString) {
+            if (!dateTimeString || dateTimeString === 'N/A') return 'N/A';
+            const date = new Date(dateTimeString);
+            return date.toLocaleString('en-US', { 
+                year: 'numeric', 
+                month: 'short', 
+                day: 'numeric',
+                hour: '2-digit',
+                minute: '2-digit',
+                hour12: true
+            });
+        }
+        
         function formatDate(dateString) {
             if (!dateString || dateString === 'N/A') return 'N/A';
             const date = new Date(dateString);
diff --git a/public/view-attendance.html b/public/view-attendance.html
index 1f81d44..2e49d3b 100644
--- a/public/view-attendance.html
+++ b/public/view-attendance.html
@@ -221,9 +221,9 @@
             document.getElementById('studentId').textContent = studentId;
             
             try {
-                // Fetch attendance records
-                const response = await fetch(
-                    `${SUPABASE_URL}/rest/v1/attendance?student_id=eq.${studentId}&select=*&order=date.desc,time_in.desc&limit=30`,
+                // First, fetch student info to get UUID
+                const studentResponse = await fetch(
+                    `${SUPABASE_URL}/rest/v1/students?student_number=eq.${studentId}&select=id,first_name,last_name,grade_level,section`,
                     {
                         headers: {
                             'apikey': SUPABASE_ANON_KEY,
@@ -232,15 +232,29 @@
                     }
                 );
                 
-                if (!response.ok) {
-                    throw new Error(`Failed to load attendance: ${response.status}`);
+                if (!studentResponse.ok) {
+                    throw new Error(`Student not found: ${studentResponse.status}`);
                 }
                 
-                const records = await response.json();
+                const students = await studentResponse.json();
+                if (students.length === 0) {
+                    showError('Student not found. Please check the student ID.');
+                    return;
+                }
                 
-                // Fetch student info
-                const studentResponse = await fetch(
-                    `${SUPABASE_URL}/rest/v1/students?student_number=eq.${studentId}&select=first_name,last_name,grade_level,section`,
+                const student = students[0];
+                const studentUUID = student.id;
+                
+                // Update student info display
+                document.getElementById('studentName').textContent = 
+                    `${student.first_name} ${student.last_name}`;
+                document.getElementById('studentDetails').innerHTML = 
+                    `Student ID: ${studentId} | Grade: ${student.grade_level} - ${student.section}`;
+                document.getElementById('studentInfo').style.display = 'block';
+                
+                // Now fetch attendance records using UUID
+                const response = await fetch(
+                    `${SUPABASE_URL}/rest/v1/attendance?student_id=eq.${studentUUID}&select=*&order=timestamp.desc&limit=30`,
                     {
                         headers: {
                             'apikey': SUPABASE_ANON_KEY,
@@ -249,18 +263,12 @@
                     }
                 );
                 
-                if (studentResponse.ok) {
-                    const students = await studentResponse.json();
-                    if (students.length > 0) {
-                        const student = students[0];
-                        document.getElementById('studentName').textContent = 
-                            `${student.first_name} ${student.last_name}`;
-                        document.getElementById('studentDetails').innerHTML = 
-                            `Student ID: ${studentId} | Grade: ${student.grade_level} - ${student.section}`;
-                    }
+                if (!response.ok) {
+                    throw new Error(`Failed to load attendance: ${response.status}`);
                 }
                 
-                document.getElementById('studentInfo').style.display = 'block';
+                const records = await response.json();
+                
                 document.getElementById('loading').style.display = 'none';
                 
                 displayAttendance(records);
@@ -275,29 +283,27 @@
             const container = document.getElementById('attendanceContainer');
             
             if (records.length === 0) {
-                container.innerHTML = '<div class="no-records">No attendance records found.</div>';
+                container.innerHTML = '<div class="no-records">ðŸ“… No attendance records found yet.<br><br>Records will appear here once student checks in at school.</div>';
                 return;
             }
             
             let html = '<table class="attendance-table">';
             html += '<thead><tr>';
-            html += '<th>Date</th>';
-            html += '<th>Time In</th>';
-            html += '<th>Time Out</th>';
+            html += '<th>Date & Time</th>';
+            html += '<th>Scan Type</th>';
             html += '<th>Status</th>';
             html += '</tr></thead>';
             html += '<tbody>';
             
             records.forEach(record => {
-                const date = record.date || 'N/A';
-                const timeIn = record.time_in ? formatTime(record.time_in) : '-';
-                const timeOut = record.time_out ? formatTime(record.time_out) : '-';
-                const status = record.status || 'unknown';
+                // Handle timestamp field (from your attendance system)
+                const timestamp = record.timestamp || record.created_at || 'N/A';
+                const scanType = record.scan_type || record.type || 'check-in';
+                const status = record.status || 'present';
                 
                 html += '<tr>';
-                html += `<td>${formatDate(date)}</td>`;
-                html += `<td>${timeIn}</td>`;
-                html += `<td>${timeOut}</td>`;
+                html += `<td>${formatDateTime(timestamp)}</td>`;
+                html += `<td><span class="status-badge status-present">${scanType.replace('_', ' ').toUpperCase()}</span></td>`;
                 html += `<td><span class="status-badge status-${status.toLowerCase()}">${status}</span></td>`;
                 html += '</tr>';
             });
@@ -306,6 +312,19 @@
             container.innerHTML = html;
         }
         
+        function formatDateTime(dateTimeString) {
+            if (!dateTimeString || dateTimeString === 'N/A') return 'N/A';
+            const date = new Date(dateTimeString);
+            return date.toLocaleString('en-US', { 
+                year: 'numeric', 
+                month: 'short', 
+                day: 'numeric',
+                hour: '2-digit',
+                minute: '2-digit',
+                hour12: true
+            });
+        }
+        
         function formatDate(dateString) {
             if (!dateString || dateString === 'N/A') return 'N/A';
             const date = new Date(dateString);
-- 
2.39.5


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>IoT Attendance - Fleet Management v2.7</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f3f4f6;
        }
        .error-banner {
            background-color: #fee2e2;
            color: #991b1b;
            padding: 12px;
            text-align: center;
            font-weight: 500;
        }
        .dev-banner {
            background-color: #fef3c7;
            color: #92400e;
            padding: 8px 12px;
            text-align: center;
            font-size: 13px;
            border-bottom: 1px solid #fbbf24;
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="dev-banner">
        ‚ö†Ô∏è Development Mode: Using CDN libraries. For production, build with compiled assets.
        <button onclick="this.parentElement.style.display='none'" style="margin-left: 10px; padding: 2px 8px; border: 1px solid #92400e; background: white; border-radius: 3px; cursor: pointer;">Dismiss</button>
    </div>
    <div id="root"></div>

    <script type="text/babel">
        // Version: 2.7 - Updated: 2025-11-29 22:50 PST - Persistent feature detection
        console.log('Dashboard v2.7 loaded - Persistent feature detection');
        const { useState, useEffect } = React;

        // Global state for multi-device availability (persisted across page reloads)
        const GlobalState = {
            get multiDeviceAvailable() {
                const cached = sessionStorage.getItem('multiDeviceAvailable');
                return cached === null ? null : cached === 'true';
            },
            set multiDeviceAvailable(value) {
                if (value === null) {
                    sessionStorage.removeItem('multiDeviceAvailable');
                } else {
                    sessionStorage.setItem('multiDeviceAvailable', value.toString());
                }
            }
        };
        
        // Log current state on load
        console.log('Multi-device feature:', GlobalState.multiDeviceAvailable === null ? 'unknown' : (GlobalState.multiDeviceAvailable ? 'enabled' : 'disabled'));

        // API Configuration - Production Ready
        const getApiConfig = () => {
            // Try to get from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const apiKey = urlParams.get('api_key') || 
                          sessionStorage.getItem('dashboard_api_key') || 
                          prompt('Enter Dashboard API Key:');
            
            if (apiKey) {
                sessionStorage.setItem('dashboard_api_key', apiKey);
            }
            
            // Use same protocol and port as current page (supports both HTTP:8080 and HTTPS:443)
            const apiBaseUrl = `${window.location.protocol}//${window.location.host}`;
            
            return { apiBaseUrl, apiKey };
        };

        const { apiBaseUrl, apiKey } = getApiConfig();

        // API Client
        const apiClient = axios.create({
            baseURL: apiBaseUrl,
            headers: {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json',
            },
            timeout: 15000,
        });

        // Fleet Overview Component
        const FleetOverview = () => {
            const [metrics, setMetrics] = useState(null);
            const [summary, setSummary] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                loadData();
                const interval = setInterval(loadData, 30000); // 30s for production
                return () => clearInterval(interval);
            }, []);

            const loadData = async (retryCount = 0) => {
                try {
                    // If we already know multi-device is disabled, skip those endpoints
                    if (GlobalState.multiDeviceAvailable === false) {
                        const [statusRes, queueRes] = await Promise.all([
                            apiClient.get('/status'),
                            apiClient.get('/queue/status')
                        ]);
                        
                        setSummary({
                            total: 1,
                            online: statusRes.data.online ? 1 : 0,
                            offline: statusRes.data.online ? 0 : 1
                        });
                        
                        setMetrics({
                            devices_with_issues: 0,
                            total_scans_today: 0,
                            total_queue_pending: queueRes.data.total || 0
                        });
                        setLoading(false);
                        return;
                    }

                    // Try multi-device endpoints first (only on first attempt)
                    try {
                        const [metricsRes, statusRes] = await Promise.all([
                            apiClient.get('/devices/metrics'),
                            apiClient.get('/devices/status')
                        ]);
                        setMetrics(metricsRes.data);
                        setSummary(statusRes.data);
                    } catch (multiDeviceError) {
                        // If multi-device disabled (503), remember it globally and use single-device endpoints
                        if (multiDeviceError.response?.status === 503) {
                            GlobalState.multiDeviceAvailable = false; // Remember globally for all components
                            
                            const [statusRes, metricsRes, queueRes] = await Promise.all([
                                apiClient.get('/status'),
                                apiClient.get('/metrics'),
                                apiClient.get('/queue/status')
                            ]);
                            
                            setSummary({
                                total: 1,
                                online: statusRes.data.online ? 1 : 0,
                                offline: statusRes.data.online ? 0 : 1
                            });
                            
                            setMetrics({
                                devices_with_issues: 0,
                                total_scans_today: metricsRes.data.total_scans_today || 0,
                                total_queue_pending: queueRes.data.total || 0
                            });
                        } else {
                            throw multiDeviceError;
                        }
                    }
                    setLoading(false);
                } catch (error) {
                    if (error.response?.status === 401 || error.response?.status === 403) {
                        sessionStorage.removeItem('dashboard_api_key');
                        alert('Authentication failed. Please refresh and enter valid API key.');
                    } else if (retryCount < 2 && error.response?.status !== 503) {
                        setTimeout(() => loadData(retryCount + 1), 2000);
                    }
                    setLoading(false);
                }
            };

            if (loading) return <div className="text-center p-4">Loading overview...</div>;
            if (!metrics || !summary) return null;

            return (
                <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-2 sm:gap-3 md:gap-4 mb-4 md:mb-6">
                    <StatCard title="Total Devices" value={summary.total} icon="üñ•Ô∏è" />
                    <StatCard title="Online" value={summary.online} icon="‚úÖ" color="text-green-600" />
                    <StatCard title="Offline" value={summary.offline} icon="‚ùå" color="text-red-600" />
                    <StatCard title="Issues" value={metrics.devices_with_issues} icon="‚ö†Ô∏è" color="text-yellow-600" />
                    <StatCard title="Today's Scans" value={metrics.total_scans_today} icon="üì∏" />
                    <StatCard title="Pending Queue" value={metrics.total_queue_pending} icon="üì§" />
                </div>
            );
        };

        const StatCard = ({ title, value, icon, color = 'text-gray-700' }) => (
            <div className="bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-md transition">
                <div className="flex items-center justify-between">
                    <div>
                        <p className="text-sm text-gray-600">{title}</p>
                        <p className={`text-3xl font-bold ${color}`}>{value}</p>
                    </div>
                    <div className="text-4xl">{icon}</div>
                </div>
            </div>
        );

        // Device Card Component
        const DeviceCard = ({ device }) => {
            const [expanded, setExpanded] = useState(false);
            const [status, setStatus] = useState(null);
            const [loading, setLoading] = useState(false);

            const loadStatus = async () => {
                setLoading(true);
                try {
                    // If we know multi-device is disabled, skip device-specific endpoint
                    if (GlobalState.multiDeviceAvailable === false) {
                        const statusResponse = await apiClient.get('/status');
                        setStatus({ device: statusResponse.data });
                        setLoading(false);
                        return;
                    }

                    const response = await apiClient.get(`/devices/${device.device_id}/status`);
                    setStatus(response.data);
                } catch (error) {
                    // If multi-device disabled (503), remember it and use general status endpoint
                    if (error.response?.status === 503) {
                        GlobalState.multiDeviceAvailable = false;
                        try {
                            const statusResponse = await apiClient.get('/status');
                            setStatus({ device: statusResponse.data });
                        } catch (statusError) {
                            // Silently handle
                        }
                    }
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                if (expanded && !status) {
                    loadStatus();
                }
            }, [expanded]);

            const timeSinceHeartbeat = (timestamp) => {
                if (!timestamp) return 'Never';
                const diff = Date.now() - new Date(timestamp).getTime();
                const minutes = Math.floor(diff / 60000);
                if (minutes < 1) return 'Just now';
                if (minutes < 60) return `${minutes}m ago`;
                return `${Math.floor(minutes / 60)}h ago`;
            };

            const getStatusBadge = (status) => {
                const colors = {
                    online: 'bg-green-500',
                    offline: 'bg-red-500',
                    error: 'bg-yellow-500',
                };
                return (
                    <span className={`px-2 py-1 rounded text-white text-xs ${colors[status] || 'bg-gray-500'}`}>
                        {status}
                    </span>
                );
            };

            return (
                <div className="border border-gray-200 rounded-lg p-3 sm:p-4 shadow-sm hover:shadow-md transition bg-white">
                    <div className="flex justify-between items-start mb-3">
                        <div className="flex-1 min-w-0">
                            <h3 className="font-bold text-base sm:text-lg text-gray-800 truncate">{device.device_name}</h3>
                            <p className="text-xs sm:text-sm text-gray-500 truncate">{device.device_id}</p>
                        </div>
                        {getStatusBadge(device.status)}
                    </div>

                    <div className="text-xs sm:text-sm space-y-1 text-gray-700 mb-3">
                        <p className="truncate">üìç {device.location || `${device.building}/${device.floor}/${device.room}`}</p>
                        <p className="truncate">üåê {device.ip_address}:{device.port || 8080}</p>
                        <p>üíì {timeSinceHeartbeat(device.last_heartbeat)}</p>
                        <p>üìä {device.total_scans || 0} scans</p>
                    </div>

                    <div className="flex gap-2">
                        <button
                            onClick={() => setExpanded(!expanded)}
                            className="text-xs sm:text-sm bg-gray-100 px-3 py-2 rounded hover:bg-gray-200 transition flex-1 sm:flex-none touch-manipulation"
                        >
                            {expanded ? 'Less' : 'More'}
                        </button>
                        <button
                            onClick={loadStatus}
                            disabled={loading}
                            className="text-xs sm:text-sm bg-blue-100 px-3 py-2 rounded hover:bg-blue-200 transition disabled:opacity-50 flex-1 sm:flex-none touch-manipulation"
                        >
                            {loading ? 'Loading...' : 'Refresh'}
                        </button>
                    </div>

                    {expanded && status && (
                        <div className="mt-4 space-y-3">
                            {/* System Status */}
                            <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                <h4 className="font-semibold text-blue-900 mb-2 flex items-center">
                                    üñ•Ô∏è System Status
                                </h4>
                                <div className="grid grid-cols-2 gap-2 text-sm">
                                    <div>
                                        <span className="text-gray-600">Online:</span>
                                        <span className={`ml-2 font-medium ${status.device?.online ? 'text-green-600' : 'text-red-600'}`}>
                                            {status.device?.online ? '‚úì Yes' : '‚úó No'}
                                        </span>
                                    </div>
                                    <div>
                                        <span className="text-gray-600">Uptime:</span>
                                        <span className="ml-2 font-medium text-blue-600">
                                            {status.device?.uptime || 'N/A'}
                                        </span>
                                    </div>
                                    <div>
                                        <span className="text-gray-600">Device ID:</span>
                                        <span className="ml-2 font-mono text-xs text-gray-800">
                                            {status.device?.device_id || 'N/A'}
                                        </span>
                                    </div>
                                    <div>
                                        <span className="text-gray-600">Version:</span>
                                        <span className="ml-2 font-medium text-gray-800">
                                            {status.device?.version || 'N/A'}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            {/* Camera Status */}
                            {status.device?.camera && (
                                <div className="bg-purple-50 border border-purple-200 rounded-lg p-3">
                                    <h4 className="font-semibold text-purple-900 mb-2 flex items-center">
                                        üì∑ Camera
                                    </h4>
                                    <div className="grid grid-cols-2 gap-2 text-sm">
                                        <div>
                                            <span className="text-gray-600">Status:</span>
                                            <span className={`ml-2 font-medium ${status.device.camera.status === 'active' ? 'text-green-600' : 'text-yellow-600'}`}>
                                                {status.device.camera.status === 'active' ? 'üü¢ Active' : 'üü° ' + status.device.camera.status}
                                            </span>
                                        </div>
                                        <div>
                                            <span className="text-gray-600">FPS:</span>
                                            <span className="ml-2 font-medium text-purple-600">
                                                {status.device.camera.fps || 'N/A'}
                                            </span>
                                        </div>
                                        <div className="col-span-2">
                                            <span className="text-gray-600">Resolution:</span>
                                            <span className="ml-2 font-medium text-gray-800">
                                                {status.device.camera.resolution || 'N/A'}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Cloud Sync Status */}
                            {status.device?.cloud && (
                                <div className="bg-green-50 border border-green-200 rounded-lg p-3">
                                    <h4 className="font-semibold text-green-900 mb-2 flex items-center">
                                        ‚òÅÔ∏è Cloud Sync
                                    </h4>
                                    <div className="grid grid-cols-2 gap-2 text-sm">
                                        <div>
                                            <span className="text-gray-600">Status:</span>
                                            <span className={`ml-2 font-medium ${status.device.cloud.enabled ? 'text-green-600' : 'text-gray-500'}`}>
                                                {status.device.cloud.enabled ? '‚úì Enabled' : '‚úó Disabled'}
                                            </span>
                                        </div>
                                        <div>
                                            <span className="text-gray-600">Connected:</span>
                                            <span className={`ml-2 font-medium ${status.device.cloud.connected ? 'text-green-600' : 'text-red-600'}`}>
                                                {status.device.cloud.connected ? 'üü¢ Yes' : 'üî¥ No'}
                                            </span>
                                        </div>
                                        <div>
                                            <span className="text-gray-600">Last Sync:</span>
                                            <span className="ml-2 text-xs text-gray-800">
                                                {status.device.cloud.last_sync ? new Date(status.device.cloud.last_sync).toLocaleString() : 'Never'}
                                            </span>
                                        </div>
                                        <div>
                                            <span className="text-gray-600">Pending:</span>
                                            <span className="ml-2 font-medium text-yellow-600">
                                                {status.device.cloud.pending_records || 0}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Queue Status */}
                            {status.device?.queue && (
                                <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                                    <h4 className="font-semibold text-yellow-900 mb-2 flex items-center">
                                        üìã Sync Queue
                                    </h4>
                                    <div className="grid grid-cols-2 gap-2 text-sm">
                                        <div>
                                            <span className="text-gray-600">Pending:</span>
                                            <span className="ml-2 font-bold text-yellow-600">
                                                {status.device.queue.pending || 0}
                                            </span>
                                        </div>
                                        <div>
                                            <span className="text-gray-600">Failed:</span>
                                            <span className="ml-2 font-bold text-red-600">
                                                {status.device.queue.failed || 0}
                                            </span>
                                        </div>
                                        <div>
                                            <span className="text-gray-600">Total Items:</span>
                                            <span className="ml-2 font-medium text-gray-800">
                                                {status.device.queue.total || 0}
                                            </span>
                                        </div>
                                        <div>
                                            <span className="text-gray-600">Oldest:</span>
                                            <span className="ml-2 text-xs text-gray-800">
                                                {status.device.queue.oldest_item ? timeSinceHeartbeat(status.device.queue.oldest_item) : 'None'}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Storage Status */}
                            {status.device?.storage && (
                                <div className="bg-indigo-50 border border-indigo-200 rounded-lg p-3">
                                    <h4 className="font-semibold text-indigo-900 mb-2 flex items-center">
                                        üíæ Storage
                                    </h4>
                                    <div className="grid grid-cols-2 gap-2 text-sm">
                                        <div>
                                            <span className="text-gray-600">Disk Used:</span>
                                            <span className="ml-2 font-medium text-indigo-600">
                                                {status.device.storage.disk_usage || 'N/A'}
                                            </span>
                                        </div>
                                        <div>
                                            <span className="text-gray-600">Photos:</span>
                                            <span className="ml-2 font-medium text-gray-800">
                                                {status.device.storage.photo_count || 0}
                                            </span>
                                        </div>
                                        <div>
                                            <span className="text-gray-600">DB Size:</span>
                                            <span className="ml-2 font-medium text-gray-800">
                                                {status.device.storage.db_size || 'N/A'}
                                            </span>
                                        </div>
                                        <div>
                                            <span className="text-gray-600">Free Space:</span>
                                            <span className="ml-2 font-medium text-green-600">
                                                {status.device.storage.free_space || 'N/A'}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Recent Activity */}
                            {status.device?.recent_scans && status.device.recent_scans.length > 0 && (
                                <div className="bg-gray-50 border border-gray-200 rounded-lg p-3">
                                    <h4 className="font-semibold text-gray-900 mb-2 flex items-center">
                                        üìä Recent Scans
                                    </h4>
                                    <div className="space-y-1 text-xs">
                                        {status.device.recent_scans.slice(0, 5).map((scan, idx) => (
                                            <div key={idx} className="flex justify-between py-1 border-b border-gray-200 last:border-0">
                                                <span className="text-gray-700">{scan.student_id || scan.student}</span>
                                                <span className="text-gray-500">{new Date(scan.timestamp).toLocaleTimeString()}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        // Device List Component
        const DeviceList = () => {
            const [devices, setDevices] = useState([]);
            const [loading, setLoading] = useState(true);
            const [filter, setFilter] = useState({ status: '', building: '' });

            useEffect(() => {
                loadDevices();
                const interval = setInterval(loadDevices, 30000);
                return () => clearInterval(interval);
            }, [filter]);

            const loadDevices = async () => {
                try {
                    // If we know multi-device is disabled, skip that endpoint
                    if (GlobalState.multiDeviceAvailable === false) {
                        const statusResponse = await apiClient.get('/status');
                        setDevices([{
                            device_id: 'pi-lab-01',
                            name: 'Main Device',
                            status: statusResponse.data.online ? 'online' : 'offline',
                            location: 'Main Lab',
                            building: 'Main Building',
                            floor: '1',
                            room: 'Lab 101',
                            ip_address: window.location.hostname,
                            port: 8080,
                            last_heartbeat: new Date().toISOString(),
                            total_scans: 0
                        }]);
                        setLoading(false);
                        return;
                    }

                    const params = {};
                    if (filter.status) params.status = filter.status;
                    if (filter.building) params.building = filter.building;

                    const response = await apiClient.get('/devices', { params });
                    setDevices(response.data.devices);
                } catch (error) {
                    // If multi-device is disabled, remember it globally and show single device
                    if (error.response?.status === 503) {
                        GlobalState.multiDeviceAvailable = false; // Remember globally
                        try {
                            const statusResponse = await apiClient.get('/status');
                            setDevices([{
                                device_id: 'pi-lab-01',
                                name: 'Main Device',
                                status: statusResponse.data.online ? 'online' : 'offline',
                                location: 'Main Lab',
                                building: 'Main Building',
                                floor: '1',
                                room: 'Lab 101',
                                ip_address: window.location.hostname,
                                port: 8080,
                                last_heartbeat: new Date().toISOString(),
                                total_scans: 0
                            }]);
                        } catch (statusError) {
                            // Silently handle
                        }
                    }
                } finally {
                    setLoading(false);
                }
            };

            if (loading) return <div className="text-center p-4">Loading devices...</div>;

            return (
                <div className="device-list">
                    <div className="filters mb-4 grid grid-cols-1 sm:grid-cols-2 lg:flex lg:flex-row gap-2 sm:gap-3">
                        <select 
                            value={filter.status}
                            onChange={(e) => setFilter({...filter, status: e.target.value})}
                            className="border border-gray-300 rounded px-3 py-2 text-sm sm:text-base w-full lg:w-auto touch-manipulation"
                        >
                            <option value="">All Status</option>
                            <option value="online">Online</option>
                            <option value="offline">Offline</option>
                            <option value="error">Error</option>
                        </select>

                        <select
                            value={filter.building}
                            onChange={(e) => setFilter({...filter, building: e.target.value})}
                            className="border border-gray-300 rounded px-3 py-2 text-sm sm:text-base w-full lg:w-auto touch-manipulation"
                        >
                            <option value="">All Buildings</option>
                            <option value="Building A">Building A</option>
                            <option value="Main Building">Main Building</option>
                        </select>

                        <button
                            onClick={loadDevices}
                            className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition text-sm sm:text-base w-full sm:col-span-2 lg:col-span-1 lg:w-auto touch-manipulation"
                        >
                            üîÑ Refresh
                        </button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4">
                        {devices.map((device) => (
                            <DeviceCard key={device.device_id} device={device} />
                        ))}
                    </div>

                    {devices.length === 0 && (
                        <div className="text-center text-gray-500 py-8">
                            No devices found.
                        </div>
                    )}
                </div>
            );
        };

        // Device Discovery Component
        const DeviceDiscovery = () => {
            const [network, setNetwork] = useState('192.168.1.0/24');
            const [discovering, setDiscovering] = useState(false);
            const [result, setResult] = useState(null);
            const [disabled, setDisabled] = useState(GlobalState.multiDeviceAvailable === false);

            const startDiscovery = async () => {
                // If we already know it's disabled, don't even try
                if (GlobalState.multiDeviceAvailable === false) {
                    setResult({
                        error: 'Multi-device management is disabled. Enable it in config to use device discovery.',
                        discovered: 0,
                        registered: 0,
                    });
                    return;
                }

                setDiscovering(true);
                setResult(null);

                try {
                    const response = await apiClient.get('/devices/discover', {
                        params: { network },
                    });
                    setResult(response.data);
                } catch (error) {
                    if (error.response?.status === 503) {
                        GlobalState.multiDeviceAvailable = false;
                        setDisabled(true);
                        setResult({
                            error: 'Multi-device management is disabled. Enable it in config to use device discovery.',
                            discovered: 0,
                            registered: 0,
                        });
                    } else {
                        setResult({
                            error: error.message,
                            discovered: 0,
                            registered: 0,
                        });
                    }
                } finally {
                    setDiscovering(false);
                }
            };

            return (
                <div className="device-discovery bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                    <h2 className="text-xl font-bold mb-4">Discover New Devices</h2>
                    
                    {disabled && (
                        <div className="bg-yellow-50 border border-yellow-200 rounded p-3 mb-4 text-sm text-yellow-800">
                            ‚ö†Ô∏è Multi-device management is currently disabled in configuration.
                        </div>
                    )}

                    <div className="mb-4">
                        <label className="block text-sm font-medium mb-2">Network Range</label>
                        <input
                            type="text"
                            value={network}
                            onChange={(e) => setNetwork(e.target.value)}
                            placeholder="192.168.1.0/24"
                            className="border border-gray-300 rounded px-3 py-2 w-full"
                            disabled={disabled}
                        />
                        <p className="text-xs text-gray-500 mt-1">
                            CIDR notation (e.g., 192.168.1.0/24)
                        </p>
                    </div>

                    <button
                        onClick={startDiscovery}
                        disabled={discovering || disabled}
                        className="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600 disabled:bg-gray-400 transition"
                    >
                        {discovering ? 'Scanning...' : 'Start Discovery'}
                    </button>

                    {result && (
                        <div className="mt-4 p-4 bg-gray-50 rounded border border-gray-200">
                            {result.error ? (
                                <div className="text-red-600">
                                    <strong>Error:</strong> {result.error}
                                </div>
                            ) : (
                                <div>
                                    <p className="text-green-600 font-medium">
                                        ‚úì Discovered {result.discovered} devices
                                    </p>
                                    <p className="text-blue-600">
                                        Registered {result.registered} new devices
                                    </p>

                                    {result.devices && result.devices.length > 0 && (
                                        <div className="mt-3">
                                            <h4 className="font-medium mb-2">Found Devices:</h4>
                                            <ul className="space-y-1 text-sm">
                                                {result.devices.map((device, idx) => (
                                                    <li key={idx} className="flex justify-between">
                                                        <span>{device.device_name}</span>
                                                        <span className="text-gray-600">{device.ip_address}</span>
                                                    </li>
                                                ))}
                                            </ul>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        // Device Location Tree Component
        const DeviceLocationTree = () => {
            const [locations, setLocations] = useState({});
            const [expanded, setExpanded] = useState({});
            const [loading, setLoading] = useState(true);
            const [disabled, setDisabled] = useState(GlobalState.multiDeviceAvailable === false);

            useEffect(() => {
                loadLocations();
            }, []);

            const loadLocations = async () => {
                try {
                    // If we already know multi-device is disabled, skip the call
                    if (GlobalState.multiDeviceAvailable === false) {
                        setLocations({
                            'Main Building': {
                                '1': {
                                    'Lab 101': 1
                                }
                            }
                        });
                        setLoading(false);
                        return;
                    }

                    const response = await apiClient.get('/locations');
                    setLocations(response.data.locations);
                } catch (error) {
                    if (error.response?.status === 503) {
                        GlobalState.multiDeviceAvailable = false;
                        setDisabled(true);
                        setLocations({
                            'Main Building': {
                                '1': {
                                    'Lab 101': 1
                                }
                            }
                        });
                    }
                } finally {
                    setLoading(false);
                }
            };

            const toggleExpand = (key) => {
                setExpanded({ ...expanded, [key]: !expanded[key] });
            };

            if (loading) return <div className="text-center p-4">Loading locations...</div>;

            return (
                <div className="location-tree bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                    <h2 className="text-xl font-bold mb-4">Device Locations</h2>
                    
                    {disabled && (
                        <div className="bg-blue-50 border border-blue-200 rounded p-3 mb-4 text-sm text-blue-800">
                            ‚ÑπÔ∏è Multi-device management is disabled. Showing single device location.
                        </div>
                    )}

                    <div className="space-y-2">
                        {Object.entries(locations).map(([building, floors]) => (
                            <div key={building}>
                                <div
                                    className="font-medium cursor-pointer hover:bg-gray-50 p-2 rounded flex items-center"
                                    onClick={() => toggleExpand(building)}
                                >
                                    <span className="mr-2">{expanded[building] ? 'üìÇ' : 'üìÅ'}</span>
                                    {building}
                                    <span className="ml-auto text-gray-500 text-sm">
                                        {Object.values(floors).reduce((sum, rooms) =>
                                            sum + Object.values(rooms).reduce((s, count) => s + count, 0), 0
                                        )} devices
                                    </span>
                                </div>

                                {expanded[building] && (
                                    <div className="ml-6 space-y-1">
                                        {Object.entries(floors).map(([floor, rooms]) => (
                                            <div key={floor}>
                                                <div
                                                    className="cursor-pointer hover:bg-gray-50 p-1 rounded flex items-center text-sm"
                                                    onClick={() => toggleExpand(`${building}/${floor}`)}
                                                >
                                                    <span className="mr-2">{expanded[`${building}/${floor}`] ? '‚ñº' : '‚ñ∂'}</span>
                                                    {floor}
                                                </div>

                                                {expanded[`${building}/${floor}`] && (
                                                    <div className="ml-6 space-y-1 text-sm text-gray-700">
                                                        {Object.entries(rooms).map(([room, count]) => (
                                                            <div key={room} className="flex justify-between">
                                                                <span>üö™ {room}</span>
                                                                <span className="text-gray-500">{count}</span>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // Configuration Editor Component
        const ConfigEditor = () => {
            const [config, setConfig] = useState(null);
            const [editing, setEditing] = useState(false);
            const [editedConfig, setEditedConfig] = useState(null);
            const [loading, setLoading] = useState(true);
            const [saving, setSaving] = useState(false);
            const [message, setMessage] = useState(null);
            const [showAdvanced, setShowAdvanced] = useState(false);
            const [viewMode, setViewMode] = useState('global'); // 'global' or 'device'

            useEffect(() => {
                loadConfig();
            }, []);

            const loadConfig = async () => {
                setLoading(true);
                try {
                    const response = await apiClient.get('/config');
                    setConfig(response.data);
                    setEditedConfig(JSON.parse(JSON.stringify(response.data))); // Deep copy
                } catch (error) {
                    setMessage({ type: 'error', text: 'Failed to load configuration' });
                } finally {
                    setLoading(false);
                }
            };

            const handleSave = async () => {
                try {
                    setSaving(true);
                    setMessage(null);
                    
                    const response = await apiClient.post('/config', editedConfig);
                    
                    setConfig(editedConfig);
                    setEditing(false);
                    
                    // Show detailed success message
                    let successMsg = '‚úÖ Configuration saved';
                    if (response.data.auto_restart) {
                        successMsg += ' ‚Ä¢ Service restarted automatically';
                    }
                    if (response.data.git_commit) {
                        successMsg += ' ‚Ä¢ Changes committed to Git';
                    }
                    
                    setMessage({ 
                        type: 'success', 
                        text: successMsg,
                        details: response.data
                    });
                } catch (error) {
                    setMessage({ type: 'error', text: error.response?.data?.error || 'Failed to save configuration' });
                } finally {
                    setSaving(false);
                }
            };

            const handleCancel = () => {
                setEditedConfig(JSON.parse(JSON.stringify(config)));
                setEditing(false);
                setMessage(null);
            };

            const updateField = (path, value) => {
                setEditedConfig(prevConfig => {
                    // Deep clone to avoid mutation issues
                    const newConfig = JSON.parse(JSON.stringify(prevConfig));
                    const keys = path.split('.');
                    let current = newConfig;
                    
                    // Create missing nested objects
                    for (let i = 0; i < keys.length - 1; i++) {
                        if (!current[keys[i]]) {
                            current[keys[i]] = {};
                        }
                        current = current[keys[i]];
                    }
                    
                    // Store as-is, type conversion happens onBlur for numbers
                    current[keys[keys.length - 1]] = value;
                    
                    return newConfig;
                });
            };

            const getField = (path) => {
                const keys = path.split('.');
                let current = editing ? editedConfig : config;
                
                for (let key of keys) {
                    if (current && typeof current === 'object') {
                        current = current[key];
                    } else {
                        return '';
                    }
                }
                
                return current;
            };

            const FormField = ({ label, path, type = 'text', options = null, disabled = false, helpText = null, placeholder = '' }) => {
                const value = getField(path);
                
                return (
                    <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                            {label}
                        </label>
                        {type === 'select' ? (
                            <select
                                value={value === null || value === undefined ? '' : value}
                                onChange={(e) => updateField(path, e.target.value)}
                                disabled={!editing || disabled}
                                className="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500 disabled:bg-gray-100"
                            >
                                {options && options.map(opt => (
                                    <option key={opt.value} value={opt.value}>{opt.label}</option>
                                ))}
                            </select>
                        ) : type === 'checkbox' ? (
                            <div className="flex items-center">
                                <input
                                    type="checkbox"
                                    checked={value === true || value === 'true'}
                                    onChange={(e) => updateField(path, e.target.checked)}
                                    disabled={!editing || disabled}
                                    className="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 disabled:bg-gray-100"
                                    style={{ cursor: (!editing || disabled) ? 'not-allowed' : 'pointer' }}
                                />
                                <span className="ml-2 text-sm text-gray-600">{(value === true || value === 'true') ? 'Enabled' : 'Disabled'}</span>
                            </div>
                        ) : type === 'number' ? (
                            <input
                                type="text"
                                inputMode="numeric"
                                value={value === null || value === undefined ? '' : value}
                                onChange={(e) => updateField(path, e.target.value)}
                                onBlur={(e) => {
                                    // Convert to number only when done typing
                                    const numValue = e.target.value === '' ? '' : Number(e.target.value);
                                    if (!isNaN(numValue) || e.target.value === '') {
                                        updateField(path, numValue);
                                    }
                                }}
                                disabled={!editing || disabled}
                                placeholder={placeholder}
                                className="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500 disabled:bg-gray-100"
                            />
                        ) : (
                            <input
                                type={type}
                                value={value === null || value === undefined ? '' : value}
                                onChange={(e) => updateField(path, e.target.value)}
                                disabled={!editing || disabled}
                                placeholder={placeholder}
                                className="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500 disabled:bg-gray-100"
                            />
                        )}
                        {helpText && (
                            <p className="mt-1 text-xs text-gray-500">{helpText}</p>
                        )}
                    </div>
                );
            };

            if (loading) return <div className="text-center p-4">Loading configuration...</div>;

            return (
                <div className="config-editor bg-white border border-gray-200 rounded-lg p-3 sm:p-4 md:p-6 shadow-sm max-w-6xl mx-auto">
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 sm:gap-0 mb-4 md:mb-6">
                        <div>
                            <h2 className="text-lg sm:text-xl md:text-2xl font-bold">Configuration Manager</h2>
                            <p className="text-xs sm:text-sm text-gray-600 mt-1">Global settings apply across all devices</p>
                        </div>
                        <div className="flex gap-2 w-full sm:w-auto">
                            {!editing ? (
                                <>
                                    <button
                                        onClick={() => setEditing(true)}
                                        className="bg-blue-500 text-white px-3 sm:px-4 py-2 rounded hover:bg-blue-600 transition text-sm sm:text-base touch-manipulation flex-1 sm:flex-none"
                                    >
                                        ‚úèÔ∏è Edit
                                    </button>
                                    <button
                                        onClick={loadConfig}
                                        className="bg-gray-500 text-white px-3 sm:px-4 py-2 rounded hover:bg-gray-600 transition text-sm sm:text-base touch-manipulation flex-1 sm:flex-none"
                                    >
                                        üîÑ Refresh
                                    </button>
                                </>
                            ) : (
                                <>
                                    <button
                                        onClick={handleSave}
                                        disabled={saving}
                                        className="bg-green-500 text-white px-3 sm:px-4 py-2 rounded hover:bg-green-600 disabled:bg-gray-400 transition text-sm sm:text-base touch-manipulation flex-1 sm:flex-none"
                                    >
                                        {saving ? 'üíæ Saving...' : 'üíæ Save'}
                                    </button>
                                    <button
                                        onClick={handleCancel}
                                        disabled={saving}
                                        className="bg-gray-500 text-white px-3 sm:px-4 py-2 rounded hover:bg-gray-600 disabled:bg-gray-400 transition text-sm sm:text-base touch-manipulation flex-1 sm:flex-none"
                                    >
                                        ‚ùå Cancel
                                    </button>
                                </>
                            )}
                        </div>
                    </div>

                    {/* View Mode Selector */}
                    <div className="mb-4 md:mb-6 flex flex-col sm:flex-row gap-2">
                        <button
                            onClick={() => setViewMode('global')}
                            className={`px-4 sm:px-6 py-2 rounded font-medium transition text-sm sm:text-base touch-manipulation ${
                                viewMode === 'global'
                                    ? 'bg-blue-500 text-white'
                                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                            }`}
                        >
                            üåê Global Settings
                        </button>
                        <button
                            onClick={() => setViewMode('device')}
                            className={`px-4 sm:px-6 py-2 rounded font-medium transition text-sm sm:text-base touch-manipulation truncate ${
                                viewMode === 'device'
                                    ? 'bg-blue-500 text-white'
                                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                            }`}
                        >
                            üñ•Ô∏è Device: {config?.device_id || 'Unknown'}
                        </button>
                    </div>

                    {message && (
                        <div className={`mb-6 p-4 rounded border ${
                            message.type === 'success' 
                                ? 'bg-green-50 border-green-200 text-green-800' 
                                : 'bg-red-50 border-red-200 text-red-800'
                        }`}>
                            {message.text}
                        </div>
                    )}

                    <div className="space-y-6">
                        {viewMode === 'global' ? (
                            <>
                                {/* Global: Multi-Device Management */}
                                <div className="bg-blue-50 p-3 sm:p-4 rounded border border-blue-200">
                                    <h3 className="text-base sm:text-lg font-semibold mb-2 text-blue-900">üåê Fleet Management</h3>
                                    <p className="text-xs sm:text-sm text-blue-700 mb-3 sm:mb-4">Controls multi-device features across the entire system</p>
                                    <FormField label="Enable Multi-Device Management" path="admin_dashboard.multi_device_enabled" type="checkbox" />
                                </div>

                                {/* Global: Cloud Sync */}
                                <div className="bg-purple-50 p-4 rounded border border-purple-200">
                                    <h3 className="text-lg font-semibold mb-2 text-purple-900">‚òÅÔ∏è Cloud Sync (Global)</h3>
                                    <p className="text-sm text-purple-700 mb-4">Applies to all devices in the fleet</p>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <FormField label="Enable Cloud Sync" path="cloud.enabled" type="checkbox" />
                                        <FormField label="Retry Attempts" path="cloud.retry_attempts" type="number" />
                                        <FormField label="Retry Delay (seconds)" path="cloud.retry_delay" type="number" />
                                        <FormField label="Cleanup Photos After Sync" path="cloud.cleanup_photos_after_sync" type="checkbox" />
                                    </div>
                                </div>

                                {/* Global: Schedule */}
                                <div className="bg-green-50 p-4 rounded border border-green-200">
                                    <h3 className="text-lg font-semibold mb-2 text-green-900">‚è∞ Schedule (Global)</h3>
                                    <p className="text-sm text-green-700 mb-4">Same schedule applied across all devices</p>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <FormField label="Morning Login Start" path="school_schedule.morning_class.login_window_start" />
                                        <FormField label="Morning Login End" path="school_schedule.morning_class.login_window_end" />
                                        <FormField label="Afternoon Login Start" path="school_schedule.afternoon_class.login_window_start" />
                                        <FormField label="Afternoon Login End" path="school_schedule.afternoon_class.login_window_end" />
                                        <FormField label="Late Threshold (minutes)" path="school_schedule.morning_class.late_threshold_minutes" type="number" />
                                    </div>
                                </div>

                                {/* Global: Dashboard */}
                                <div className="bg-yellow-50 p-4 rounded border border-yellow-200">
                                    <h3 className="text-lg font-semibold mb-2 text-yellow-900">üñ•Ô∏è Admin Dashboard (Global)</h3>
                                    <p className="text-sm text-yellow-700 mb-4">Central dashboard for fleet management</p>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <FormField label="Enable Dashboard" path="admin_dashboard.enabled" type="checkbox" />
                                        <FormField label="Enable Authentication" path="admin_dashboard.auth_enabled" type="checkbox" />
                                        <FormField label="Port" path="admin_dashboard.port" type="number" />
                                        <FormField label="Host" path="admin_dashboard.host" />
                                    </div>
                                </div>

                                {/* Global: SMS Notifications */}
                                <div className="bg-pink-50 p-4 rounded border border-pink-200">
                                    <h3 className="text-lg font-semibold mb-2 text-pink-900">üì± SMS Notifications (Global)</h3>
                                    <p className="text-sm text-pink-700 mb-4">SMS settings apply to all devices</p>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <FormField label="Enable SMS" path="sms_notifications.enabled" type="checkbox" />
                                        <FormField label="Send on Check-In" path="sms_notifications.notification_preferences.check_in" type="checkbox" />
                                        <FormField label="Send on Check-Out" path="sms_notifications.notification_preferences.check_out" type="checkbox" />
                                        <FormField label="Send Late Alerts" path="sms_notifications.notification_preferences.late_arrival" type="checkbox" />
                                    </div>
                                </div>
                            </>
                        ) : (
                            <>
                                {/* Device: Identification */}
                                <div className="bg-gray-50 p-4 rounded border border-gray-200">
                                    <h3 className="text-lg font-semibold mb-2 text-gray-800">üè∑Ô∏è Device Identification</h3>
                                    <p className="text-sm text-gray-600 mb-4">Unique settings for this specific device</p>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <FormField label="Device ID" path="device_id" />
                                        <FormField label="Device Name" path="device_name" />
                                        <FormField label="Building" path="location.building" />
                                        <FormField label="Floor" path="location.floor" />
                                        <FormField label="Room" path="location.room" />
                                    </div>
                                </div>

                                {/* Device: Camera Settings */}
                                <div className="bg-indigo-50 p-4 rounded border border-indigo-200">
                                    <h3 className="text-lg font-semibold mb-2 text-indigo-900">üì∑ Camera (Device Specific)</h3>
                                    <p className="text-sm text-indigo-700 mb-4">Camera hardware configuration for this device</p>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <FormField label="Camera Index" path="camera.index" type="number" />
                                        <FormField label="FPS" path="camera.fps" type="number" />
                                        <FormField label="Resolution Width" path="camera.resolution.width" type="number" />
                                        <FormField label="Resolution Height" path="camera.resolution.height" type="number" />
                                    </div>
                                </div>

                                {/* Device: Photo Storage */}
                                <div className="bg-teal-50 p-4 rounded border border-teal-200">
                                    <h3 className="text-lg font-semibold mb-2 text-teal-900">üíæ Local Storage (Device)</h3>
                                    <p className="text-sm text-teal-700 mb-4">Local photo and data storage settings</p>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <FormField label="Cleanup Photos After Sync" path="cloud.cleanup_photos_after_sync" type="checkbox" />
                                        <FormField label="Photo Retention Days" path="disk_monitor.photo_retention_days" type="number" />
                                        <FormField label="Photo Max Size (MB)" path="disk_monitor.photo_max_size_mb" type="number" />
                                        <FormField label="Log Retention Days" path="disk_monitor.log_retention_days" type="number" />
                                    </div>
                                </div>

                                {/* Device: Hardware */}
                                <div className="bg-orange-50 p-4 rounded border border-orange-200">
                                    <h3 className="text-lg font-semibold mb-2 text-orange-900">üîß Hardware Settings</h3>
                                    <p className="text-sm text-orange-700 mb-4">Device-specific hardware configuration</p>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <FormField label="Enable Buzzer" path="buzzer.enabled" type="checkbox" />
                                        <FormField label="Buzzer GPIO Pin" path="buzzer.gpio_pin" type="number" />
                                        <FormField label="Enable RGB LED" path="rgb_led.enabled" type="checkbox" />
                                        <FormField label="LED Brightness %" path="rgb_led.brightness" type="number" />
                                    </div>
                                </div>

                                {/* Device: Advanced Settings */}
                                <div className="border-t pt-4">
                                    <button
                                        onClick={() => setShowAdvanced(!showAdvanced)}
                                        className="text-blue-600 hover:text-blue-800 font-medium flex items-center gap-2"
                                    >
                                        {showAdvanced ? '‚ñº' : '‚ñ∂'} Advanced Device Settings
                                    </button>
                                </div>

                                {showAdvanced && (
                                    <div className="bg-gray-50 p-4 rounded border border-gray-200">
                                        <h3 className="text-lg font-semibold mb-4 text-gray-800">üî¨ Advanced</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <FormField label="Network Connect Timeout (s)" path="network_timeouts.connect_timeout" type="number" />
                                            <FormField label="Network Read Timeout (s)" path="network_timeouts.read_timeout" type="number" />
                                            <FormField label="Shutdown Timeout (s)" path="shutdown.timeout" type="number" />
                                        </div>
                                    </div>
                                )}
                            </>
                        )}

                        {/* Important Notice */}
                        <div className="bg-blue-50 border border-blue-200 rounded p-4">
                            <h3 className="font-semibold text-blue-800 mb-2">ü§ñ Automated Updates</h3>
                            <ul className="text-sm space-y-1 text-gray-700">
                                <li>‚úÖ Automatic backup created before each save</li>
                                <li>‚úÖ Service automatically restarted after changes</li>
                                <li>‚úÖ Changes automatically committed and pushed to Git</li>
                                <li className="mt-2 text-xs text-gray-600">Manual restart (if needed): <code className="bg-white px-2 py-1 rounded font-mono text-xs">sudo systemctl restart attendance-dashboard.service</code></li>
                            </ul>
                        </div>
                    </div>
                </div>
            );
        };

        // Main Dashboard Component
        const MultiDeviceDashboard = () => {
            const [activeTab, setActiveTab] = useState('overview');

            return (
                <div className="multi-device-dashboard p-3 sm:p-4 md:p-6 bg-gray-100 min-h-screen">
                    <header className="mb-4 md:mb-6">
                        <h1 className="text-xl sm:text-2xl md:text-3xl font-bold text-gray-800">
                            IoT Attendance System
                        </h1>
                        <p className="text-sm sm:text-base text-gray-600 mt-1">Fleet Management Dashboard</p>
                    </header>

                    <nav className="flex gap-1 sm:gap-2 mb-4 md:mb-6 border-b border-gray-300 overflow-x-auto">
                        {['overview', 'devices', 'discover', 'locations', 'config'].map((tab) => (
                            <button
                                key={tab}
                                onClick={() => setActiveTab(tab)}
                                className={`px-3 sm:px-4 py-2 font-medium capitalize transition whitespace-nowrap text-sm sm:text-base ${
                                    activeTab === tab
                                        ? 'border-b-2 border-blue-500 text-blue-600'
                                        : 'text-gray-600 hover:text-gray-800'
                                }`}
                            >
                                {tab === 'config' ? '‚öôÔ∏è Config' : tab}
                            </button>
                        ))}
                    </nav>

                    <main>
                        {activeTab === 'overview' && (
                            <>
                                <FleetOverview />
                                <DeviceList />
                            </>
                        )}

                        {activeTab === 'devices' && <DeviceList />}

                        {activeTab === 'discover' && <DeviceDiscovery />}

                        {activeTab === 'locations' && <DeviceLocationTree />}

                        {activeTab === 'config' && <ConfigEditor />}
                    </main>
                </div>
            );
        };

        // Render the app
        ReactDOM.render(<MultiDeviceDashboard />, document.getElementById('root'));
    </script>
</body>
</html>
